// src/pages/Stock.tsx
import { useEffect, useState } from "react";
import { listStock, type Stock } from "../api/stock";
import { listSucursales, type Sucursal } from "../api/locations";
import { tokenStorage } from "../utils/storage";
import { 
  Card, 
  CardHeader, 
  CardTitle, 
  CardDescription, 
  CardBody, 
  Badge, 
  PageLoader,
  Alert,
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableHead,
  TableCell
} from "../components/ui";
import { Package, MapPin, Thermometer, Refrigerator, Snowflake, Calendar, TrendingUp, Filter } from "lucide-react";
import clsx from 'clsx';

export default function StockPage() {
  const [items, setItems] = useState<Stock[]>([]);
  const [filteredItems, setFilteredItems] = useState<Stock[]>([]);
  const [err, setErr] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);
  
  const [filterTipo, setFilterTipo] = useState<string>("all");
  const [filterSubUbicacion, setFilterSubUbicacion] = useState<string>("all");
  const [soloConStock, setSoloConStock] = useState(true);

  // Estados para admin
  const [sucursales, setSucursales] = useState<Sucursal[]>([]);
  const [selectedSucursal, setSelectedSucursal] = useState<number | undefined>(undefined);

  const sucursal = tokenStorage.getSucursal();
  const session = tokenStorage.getSession();
  const isAdmin = session?.rol === "admin";

  // Cargar sucursales si es admin
  useEffect(() => {
    if (isAdmin) {
      listSucursales()
        .then(setSucursales)
        .catch((e) => console.error("Error cargando sucursales:", e));
    }
  }, [isAdmin]);

  useEffect(() {
    async function load() {
      setErr(null);
      setLoading(true);
      try {
        // Si es admin, usar selectedSucursal; si no, usar la sucursal del usuario
        const ubicacionParam = isAdmin ? selectedSucursal : sucursal;
        const data = await listStock({ 
          solo_con_stock: soloConStock,
          ubicacion: ubicacionParam ?? undefined 
        });
        setItems(data);
        setFilteredItems(data);
      } catch (e: any) {
        setErr(e?.message ?? "Error cargando stock");
      } finally {
        setLoading(false);
      }
    }
    load();
  }, [soloConStock, sucursal, selectedSucursal, isAdmin]);

  // Aplicar filtros locales
  useEffect(() => {
    let filtered = [...items];
    
    if (filterTipo !== "all") {
      filtered = filtered.filter(item => item.producto_tipo_conservacion === filterTipo);
    }
    
    if (filterSubUbicacion !== "all") {
      filtered = filtered.filter(item => item.sub_ubicacion.toString() === filterSubUbicacion);
    }
    
    setFilteredItems(filtered);
  }, [items, filterTipo, filterSubUbicacion]);

  const subUbicaciones = Array.from(
    new Map(items.map(item => [item.sub_ubicacion, item.sub_ubicacion_nombre])).entries()
  );

  const totalItems = filteredItems.reduce((sum, item) => sum + item.cantidad, 0);

  const getTipoIcon = (tipo: string) => {
    switch (tipo) {
      case "ambiente":
        return <Thermometer className="h-4 w-4" />;
      case "heladera":
        return <Refrigerator className="h-4 w-4" />;
      case "freezer":
        return <Snowflake className="h-4 w-4" />;
      default:
        return <Package className="h-4 w-4" />;
    }
  };

  const getTipoBadgeVariant = (tipo: string): "default" | "draft" | "pending" | "approved" => {
    switch (tipo) {
      case "ambiente":
        return "approved";
      case "heladera":
        return "pending";
      case "freezer":
        return "draft";
      default:
        return "default";
    }
  };

  const getCantidadColor = (cantidad: number) => {
    if (cantidad < 10) return "text-red-600";
    if (cantidad < 50) return "text-orange-600";
    return "text-emerald-600";
  };

  if (loading) {
    return <PageLoader message="Cargando inventario..." />;
  }

  // Obtener nombre de sucursal
  const sucursalNombre = isAdmin
    ? selectedSucursal
      ? sucursales.find(s => s.id === selectedSucursal)?.nombre ?? "Todas las sucursales"
      : "Todas las sucursales"
    : session?.sucursal ?? "Sucursal";

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-2xl font-bold text-neutral-900">Stock - {sucursalNombre}</h1>
        <p className="text-sm text-neutral-500 mt-1">
          {isAdmin ? "Vista de inventario por sucursal" : "Productos disponibles en todas las sub-ubicaciones"}
        </p>
      </div>

      {/* Alert de errores */}
      {err && <Alert variant="error">{err}</Alert>}

      {/* Filtros */}
      <Card>
        <CardHeader>
          <div className="flex items-center gap-2">
            <Filter className="h-5 w-5 text-primary-600" />
            <CardTitle className="text-base">Filtros</CardTitle>
          </div>
        </CardHeader>
        <CardBody>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {isAdmin && (
              <div>
                <label className="block text-sm font-medium text-neutral-700 mb-2">
                  Sucursal
                </label>
                <select 
                  value={selectedSucursal ?? ""} 
                  onChange={(e) => setSelectedSucursal(e.target.value ? Number(e.target.value) : undefined)}
                  className="w-full px-3.5 py-2.5 rounded-xl border text-sm transition-all bg-white text-neutral-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent border-neutral-300 hover:border-neutral-400"
                >
                  <option value="">Todas las sucursales</option>
                  {sucursales.map((s) => (
                    <option key={s.id} value={s.id}>
                      {s.nombre}
                    </option>
                  ))}
                </select>
              </div>
            )}
            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">
                Tipo de conservación
              </label>
              <select 
                value={filterTipo} 
                onChange={(e) => setFilterTipo(e.target.value)}
                className="w-full px-3.5 py-2.5 rounded-xl border text-sm transition-all bg-white text-neutral-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent border-neutral-300 hover:border-neutral-400"
              >
                <option value="all">Todos</option>
                <option value="ambiente">Ambiente</option>
                <option value="heladera">Heladera</option>
                <option value="freezer">Freezer</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-neutral-700 mb-2">
                Sub-ubicación
              </label>
              <select 
                value={filterSubUbicacion} 
                onChange={(e) => setFilterSubUbicacion(e.target.value)}
                className="w-full px-3.5 py-2.5 rounded-xl border text-sm transition-all bg-white text-neutral-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent border-neutral-300 hover:border-neutral-400"
              >
                <option value="all">Todas</option>
                {subUbicaciones.map(([id, nombre]) => (
                  <option key={id} value={id.toString()}>{nombre}</option>
                ))}
              </select>
            </div>

            <div className="flex items-end">
              <label className="flex items-center gap-2 cursor-pointer px-4 py-2.5 rounded-xl border border-neutral-300 hover:border-primary-400 hover:bg-primary-50 transition-all">
                <input 
                  type="checkbox" 
                  checked={soloConStock} 
                  onChange={(e) => setSoloConStock(e.target.checked)}
                  className="w-4 h-4 text-primary-600 border-neutral-300 rounded focus:ring-primary-500"
                />
                <span className="text-sm font-medium text-neutral-700">Solo con stock</span>
              </label>
            </div>
          </div>
        </CardBody>
      </Card>

      {/* Resumen - Cards de métricas */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <Card className="bg-gradient-to-br from-primary-50 to-white border-primary-100">
          <CardBody className="flex items-center gap-4">
            <div className="p-3 bg-primary-100 rounded-xl">
              <Package className="h-6 w-6 text-primary-600" />
            </div>
            <div>
              <div className="text-sm text-neutral-600">Total productos</div>
              <div className="text-3xl font-bold text-neutral-900">{filteredItems.length}</div>
            </div>
          </CardBody>
        </Card>

        <Card className="bg-gradient-to-br from-emerald-50 to-white border-emerald-100">
          <CardBody className="flex items-center gap-4">
            <div className="p-3 bg-emerald-100 rounded-xl">
              <TrendingUp className="h-6 w-6 text-emerald-600" />
            </div>
            <div>
              <div className="text-sm text-neutral-600">Total unidades</div>
              <div className="text-3xl font-bold text-neutral-900">{totalItems}</div>
            </div>
          </CardBody>
        </Card>
      </div>

      {/* Tabla de inventario */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Inventario</CardTitle>
              <CardDescription>{filteredItems.length} productos</CardDescription>
            </div>
          </div>
        </CardHeader>
        <CardBody className="p-0">
          {filteredItems.length === 0 ? (
            <div className="text-center py-12">
              <Package className="h-16 w-16 text-neutral-300 mx-auto mb-4" />
              <p className="text-neutral-500">No hay productos en stock</p>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Producto</TableHead>
                    <TableHead>Sub-ubicación</TableHead>
                    <TableHead className="text-center">Tipo</TableHead>
                    <TableHead className="text-right">Cantidad</TableHead>
                    <TableHead>Última actualización</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {filteredItems.map((item) => (
                    <TableRow key={item.id}>
                      <TableCell>
                        <div className="font-medium text-neutral-900">{item.producto_nombre}</div>
                      </TableCell>
                      <TableCell>
                        <div className="flex items-center gap-2 text-sm text-neutral-600">
                          <MapPin className="h-3 w-3" />
                          {item.sub_ubicacion_nombre}
                        </div>
                      </TableCell>
                      <TableCell className="text-center">
                        <Badge variant={getTipoBadgeVariant(item.producto_tipo_conservacion)}>
                          <div className="flex items-center gap-1.5">
                            {getTipoIcon(item.producto_tipo_conservacion)}
                            {item.producto_tipo_conservacion.charAt(0).toUpperCase() + item.producto_tipo_conservacion.slice(1)}
                          </div>
                        </Badge>
                      </TableCell>
                      <TableCell className="text-right">
                        <span className={clsx("font-bold text-lg", getCantidadColor(item.cantidad))}>
                          {item.cantidad}
                        </span>
                      </TableCell>
                      <TableCell>
                        <div className="flex items-center gap-2 text-xs text-neutral-500">
                          <Calendar className="h-3 w-3" />
                          {new Date(item.ultima_actualizacion).toLocaleDateString("es-AR", {
                            day: "2-digit",
                            month: "2-digit",
                            year: "numeric",
                            hour: "2-digit",
                            minute: "2-digit"
                          })}
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </div>
          )}
        </CardBody>
      </Card>
    </div>
  );
}
